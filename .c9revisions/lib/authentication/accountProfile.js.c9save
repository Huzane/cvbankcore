{"ts":1380277210827,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"var util = require('util');\nvar events = require(\"events\");\nvar _ = require('underscore');\n\n\nvar ACCOUNT_NOT_FOUND = -404, //Account was not found or has been deleted\nACCOUNT_INCORRENT_PASSWORD = -10,//The password is not correct\nACCOUNT_LOCKED = -15,//Account is locked\nACCOUNT_DELETED = -25,//Account is locked\nACCOUNT_PROFILE_NOT_FOUND = -400, //The account was found, password is correct but the profile was not found\nACCOUNT_GENERAL_ERROR = -100, //A general error occured\nACCOUNT_OK = 100; //The account was found, the password is correct and the profile was found\n\n\nvar accountProfile = function(){\n\tevents.EventEmitter.call(this);\n\tvar Account = require('../../models/account.js');\n\tthis.accountHandler = new Account();\n\t\n\tthis.bootStrap = function(identity,password){\n\t\tvar self = this;\n\t\tself.emit(\"bootstrap\",{identity:identity, password:password});\n\t\treturn this;\n\t};\n\n\tthis.profileMaps = {\n\t\t'parent' : function(account, callback){\n\t\t\tvar  parent = require('').Parent;\n\t\t\tvar c = new parent();\n\t\t\tc.first({accountID : account._id}, callback);\n\t\t},\n\t\t'school': function(account, callback){\n\t\t\tvar school = require('').School;\n\t\t\tvar c = new school();\n\t\t\tc.first({accountID: account._id}, callback);\n\t\t},\n\t\t'student': function(account, callback){\n\t\t\tvar student = require('').Student;\n\t\t\tvar c = new student();\n\t\t\tc.first({accountID: account._id}, callback);\n\t\t},\n\t\t'admin': function(account, callback){\n\t\t\tvar admin = require('').Admin;\n\t\t\tvar c = new admin();\n\t\t\tc.first({accountID: account._id}, callback);\n\t\t}\n\t};\n\n\tthis._checkIdentity = function(properties){\n\t\tvar self = this;\n\t\tvar accountHandler = this.accountHandler;\n\t\taccountHandler.find(properties.identity, function(data){\n\t\tif(data===null)\n\t\t{\n\t\t\tself.emit('complete',{status:ACCOUNT_NOT_FOUND, data:'Identity or password do not exist'});\t\t\n\t\t}else if(util.isError(data)){\n\t\t\tself.emit('complete',{status: ACCOUNT_GENERAL_ERROR, data:data.message});\n\t\t}else if(data.status==='locked' || data.activated !==true){\n\t\t\tself.emit('complete', {status: ACCOUNT_LOCKED, data:'Account has not been activated or it is locked'});\n\t\t}else if(data.status==='deleted'){\n\t\t\tself.emit('complete', {status: ACCOUNT_NOT_FOUND, data:'Account not found'});\n\t\t}else{\n\t\t\tself.emit('verifyPassword', data, properties.password);\n\t\t}\n\t\t});\n\t};\n\n\tthis._verifyPassword = function(data, password){\n\t\tvar self = this;\n\t\tthis.accountHandler.comparePassword(data.password, password, function(ptv){\n\t\t\tif(ptv === true)\n\t\t\t{\n\t\t\t\tself.emit('fetchProfile', data);\n\t\t\t}else{\n\t\t\t\tself.emit('complete',{status: ACCOUNT_INCORRENT_PASSWORD , data:'Incorrect Password'});\n\t\t\t}\n\t\t});\n\t\t\n\n\t};\n\n\n\tthis._fetchProfile = function(account){\n\t\tvar self = this;\n\t\tvar profileType = account.accountType;\n\t\tvar profileHandler = this.profileMaps[profileType];\n\t\tprofileHandler(account, function(profile){\n\t\t\tif(profile){\n\t\t\t\tself.emit('complete', profile);\n\t\t\t}else{\n\t\t\t\tself.emit('complete', {status : ACCOUNT_PROFILE_NOT_FOUND, data : 'Profile not found'});\n\t\t\t}\n\t\t});\n\t};\n\n\tthis.on('bootstrap', this._checkIdentity);\n\tthis.on('verifyPassword', this._verifyPassword);\n\tthis.on('fetchProfile', this._fetchProfile);\n};\n\nutil.inherits(accountProfile, events.EventEmitter);\n\nmodule.exports = new accountProfile();"]],"start1":0,"start2":0,"length1":0,"length2":3233}]],"length":3233}
{"contributors":[],"silentsave":false,"ts":1380277833658,"patch":[[{"diffs":[[0," = require('"],[1,"../../models/companyuser.js"],[0,"').School;\n\t"]],"start1":1115,"start2":1115,"length1":24,"length2":51},{"diffs":[[0,"equire('"],[1,"../../models/companyuser.js"],[0,"').Stude"]],"start1":1303,"start2":1303,"length1":16,"length2":43}]],"length":3287,"saved":false}
{"ts":1380277904709,"patch":[[{"diffs":[[0,");\n\t\t},\n"],[1,"\t\t\n\t\t'teacher': function(account, callback){\n\t\t    var teacher = \n\t\t    var c = new teacher();\n\t\t    c.first({accountID: account._id}, callback);\n\t\t},\n"],[0,"\t\t'admin"]],"start1":1421,"start2":1421,"length1":16,"length2":167}]],"length":3438,"saved":false}
{"ts":1380278067546,"patch":[[{"diffs":[[0,"e('../../models/"],[-1,"company"],[1,"school"],[0,"user.js').School"]],"start1":1124,"start2":1124,"length1":39,"length2":38},{"diffs":[[0,").School"],[1,"User"],[0,";\n\t\t\tvar"]],"start1":1154,"start2":1154,"length1":16,"length2":20},{"diffs":[[0,"els/"],[-1,"company"],[1,"school"],[0,"user"]],"start1":1323,"start2":1323,"length1":15,"length2":14},{"diffs":[[0,"r.js').S"],[-1,"tudent"],[1,"choolUser"],[0,";\n\t\t\tvar"]],"start1":1336,"start2":1336,"length1":22,"length2":25}]],"length":3443,"saved":false}
{"ts":1380278080526,"patch":[[{"diffs":[[0,"acher = "],[1,"require('../../models/schooluser.js').SchoolUser;"],[0,"\n\t\t    v"]],"start1":1491,"start2":1491,"length1":16,"length2":65}]],"length":3492,"saved":false}
{"ts":1380278150126,"patch":[[{"diffs":[[0,"{\n\t\t"],[-1,"\tvar admin = require('').Admin;\n\t\t\tvar c = new admin();\n\t\t\tc.first({accountID: account._id}, callback"],[1,"    callback({\n\t\t       displayName : account.identity,\n\t\t\t\t_id : account._id,\n\t\t\t\tcreatedOn : account.createdOn \n\t\t    }"],[0,");\n\t"]],"start1":1672,"start2":1672,"length1":109,"length2":129}]],"length":3512,"saved":false}
{"ts":1380278195527,"patch":[[{"diffs":[[0," callback){\n"],[-1,"\t\t"],[1,"        "],[0,"    var teac"]],"start1":1467,"start2":1467,"length1":26,"length2":32},{"diffs":[[0,"olUser;\n"],[-1,"\t\t"],[1,"        "],[0,"    var "]],"start1":1547,"start2":1547,"length1":18,"length2":24},{"diffs":[[0,"cher();\n"],[-1,"\t\t"],[1,"        "],[0,"    c.fi"]],"start1":1582,"start2":1582,"length1":18,"length2":24},{"diffs":[[0,"\t       "],[1," "],[0,"displayN"]],"start1":1710,"start2":1710,"length1":16,"length2":17},{"diffs":[[0,"tity,\n\t\t"],[-1,"\t\t"],[1,"        "],[0,"_id : ac"]],"start1":1745,"start2":1745,"length1":18,"length2":24},{"diffs":[[0,"._id,\n\t\t"],[-1,"\t\t"],[1,"        "],[0,"createdO"]],"start1":1774,"start2":1774,"length1":18,"length2":24}]],"length":3543,"saved":false}
{"ts":1380278698436,"patch":[[{"diffs":[[0,"equire('"],[1,"../../models/schooluser.js"],[0,"').Paren"]],"start1":963,"start2":963,"length1":16,"length2":42}]],"length":3569,"saved":false}
{"ts":1380278740500,"patch":[[{"diffs":[[0,"e('../../models/"],[-1,"school"],[1,"parent"],[0,"user.js').Parent"]],"start1":968,"start2":968,"length1":38,"length2":38},{"diffs":[[0,").Parent"],[1,"User"],[0,";\n\t\t\tvar"]],"start1":998,"start2":998,"length1":16,"length2":20}]],"length":3573,"saved":false}
